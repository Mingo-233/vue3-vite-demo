<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body></body>

  <script>
    // 定义一个“仓库”，用于存储触发函数
    let store = new WeakMap();
    let activeEffect; // 新增
    function effect(fn) {
      // 将操作包装为一个函数
      const effectFn = () => {
        activeEffect = effectFn;
        fn();
      };
      effectFn();
    }

    function reactive(obj) {
      return new Proxy(obj, {
        get(target, key) {
          // 收集依赖
          track(target, key);
          console.log(store);
          return target[key];
        },
        set(target, key, newVal) {
          target[key] = newVal;
          // 触发依赖
          trigger(target, key);
        },
      });
    }

    function track(target, key) {
      // 如果没有依赖函数，则不需要进行收集。直接return
      if (!activeEffect) return;
      console.log(target);
      // 获取target，也就是对象名，对应上面例子中的data
      let depsMap = store.get(target);
      console.log("track");
      if (!depsMap) {
        store.set(target, (depsMap = new Map()));
      }
      // 获取对象中的key值，对应上面例子中的name或age
      let deps = depsMap.get(key);

      if (!deps) {
        depsMap.set(key, (deps = new Set()));
      }
      // 收集依赖函数
      deps.add(activeEffect);
    }

    function trigger(target, key) {
      // 取出对象对应的Map
      let depsMap = store.get(target);
      if (!depsMap) return;
      // 取出key所对应的Set
      let deps = depsMap.get(key);
      // 执行依赖函数
      deps && deps.forEach((fn) => fn());
    }

    // 使用proxy进行代理
    // let data_proxy = reactive({
    //   name: "pino",
    //   age: 18,
    // });
    // console.log(data_proxy.age);

    const obj = {
      foo: 1,
      get bar() {
        return this.foo;
      },
    };
    let obj_proxy = reactive(obj);

    effect(() => {
      //   nextVal = data.age + 1;
      //   console.log(nextVal);
      console.log("update effect");
      console.log(obj_proxy.bar); // 1
    });
    obj_proxy.foo++;
    // data_proxy.age++; // 2秒后输出 20
    // console.log(data_proxy.age);
  </script>
</html>
